---
- name: Install Tailscale using official install script
  shell: curl -fsSL https://tailscale.com/install.sh | sh
  args:
    creates: /usr/bin/tailscale

- name: Start and enable Tailscale service
  systemd:
    name: tailscaled
    state: started
    enabled: yes

- name: Get subnet information for route advertisement
  shell: |
    if [ -f /sys/class/net/ens4/address ]; then
      ip route show dev ens4 | grep -E '^10\.' | head -1 | awk '{print $1}'
    else
      echo "10.128.0.0/20"
    fi
  register: subnet_cidr
  changed_when: false

- name: Create Tailscale setup script
  template:
    content: |
      #!/bin/bash
      # Tailscale login and GCE configuration script
      # This script should be run manually after deployment
      
      echo "Setting up Tailscale for GCE..."
      
      # Step 1: Login to Tailscale (interactive authentication)
      echo "Run the following command to authenticate:"
      echo "sudo tailscale up"
      echo ""
      echo "This will provide a URL to complete authentication in your browser."
      echo ""
      
      # Step 2: Configure subnet routing for GCE
      echo "After authentication, configure subnet routing:"
      echo "sudo tailscale set --advertise-routes={{ subnet_cidr.stdout | default('10.128.0.0/20') }} --accept-dns=false"
      echo ""
      
      # Step 3: Enable IP forwarding (already enabled in Terraform)
      echo "IP forwarding is already enabled via Terraform configuration."
      echo ""
      
      echo "Tailscale setup complete!"
      echo "Remember to:"
      echo "1. Approve subnet routes in Tailscale admin console"
      echo "2. Consider disabling SSH access via public IP for security"
    dest: /home/{{ user_name }}/setup-tailscale-gce.sh
    mode: '0755'
  become_user: "{{ user_name }}"

- name: Display Tailscale GCE setup instructions
  debug:
    msg: |
      Tailscale has been installed successfully for GCE.
      
      Next steps:
      1. Run the setup script: ./setup-tailscale-gce.sh
      2. Authenticate: sudo tailscale up
      3. Follow the URL provided to complete authentication
      4. Configure subnet routing: sudo tailscale set --advertise-routes={{ subnet_cidr.stdout | default('10.128.0.0/20') }} --accept-dns=false
      5. Approve subnet routes in Tailscale admin console
      
      Detected subnet: {{ subnet_cidr.stdout | default('10.128.0.0/20') }}